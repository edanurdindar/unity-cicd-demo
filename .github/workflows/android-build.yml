name: Android - Build (APK/AAB)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      # (1) Free up disk space for large Unity Docker image layers
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          swap-storage: true
          large-packages: true

      # (2) Workaround for Maven Central 403: use Google Maven Central mirror
      - name: Configure Gradle Maven mirror (workaround for 403)
        shell: bash
        run: |
          mkdir -p .gradle/init.d
          cat > .gradle/init.d/maven-mirror.gradle <<'EOF'
          def centralMirror = "https://maven-central.storage-download.googleapis.com/maven2/"
          settingsEvaluated { s ->
            try {
              s.pluginManagement.repositories.clear()
              s.pluginManagement.repositories {
                maven { url centralMirror }
                gradlePluginPortal()
                google()
                mavenCentral()
              }
            } catch (ignored) {}
            try {
              s.dependencyResolutionManagement.repositories.clear()
              s.dependencyResolutionManagement.repositories {
                maven { url centralMirror }
                google()
                mavenCentral()
              }
            } catch (ignored) {}
          }
          allprojects {
            buildscript {
              repositories {
                maven { url centralMirror }
                google()
                mavenCentral()
                gradlePluginPortal()
              }
            }
            repositories {
              maven { url centralMirror }
              google()
              mavenCentral()
            }
          }
          EOF

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Android-${{ hashFiles('ProjectSettings/ProjectVersion.txt','Packages/manifest.json','Packages/packages-lock.json','Assets/**','ProjectSettings/**') }}
          restore-keys: |
            Library-Android-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            .gradle/caches
            .gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # Safe check: do NOT print license, only check it's present
      - name: Check Unity license secret is present
        shell: bash
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        run: |
          [ -n "$UNITY_LICENSE" ] && echo "UNITY_LICENSE OK" || (echo "UNITY_LICENSE EMPTY" && exit 1)
         
      - name: Build Android
        uses: game-ci/unity-builder@v4
        env:
          # Point Gradle to repo-local home so our init.d mirror + caches are used
          GRADLE_USER_HOME: /github/workspace/.gradle

          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android
          allowDirtyBuild: true
          buildsPath: build
          buildName: Unity-Android
          customParameters: -logFile ./Editor.log

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/Android

      # Always upload Unity log (helps debug failures)
      - name: Upload Unity logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-logs
          path: Editor.log
          if-no-files-found: ignore

      - name: Notify Slack (build link)
        if: success()
        shell: bash
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="✅ Android build hazır!\n• Repo: ${{ github.repository }}\n• Branch: ${{ github.ref_name }}\n• Run: ${RUN_URL}\n\n➡️ Artifacts bölümünden *android-build* indir."
          payload=$(printf '{"text":"%s"}' "$(echo "$TEXT" | sed 's/"/\\"/g')")
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

